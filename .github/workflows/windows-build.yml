name: Windows Build

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-msvc:
    name: build (windows-x64-msvc)
    runs-on: windows-2022

    env:
      VCPKG_DEFAULT_TRIPLET: x64-windows-static

    steps:
    - name: Checkout code
      uses: actions/checkout@v5

    - name: Cache vcpkg packages
      uses: actions/cache@v4
      with:
        path: |
          ~\AppData\Local\vcpkg\archives
          vcpkg_installed
        key: vcpkg-windows-x64-static-${{ hashFiles('vcpkg.json') }}
        restore-keys: |
          vcpkg-windows-x64-static-

    - name: Setup MSVC
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: x64

    - name: Setup vcpkg
      uses: lukka/run-vcpkg@v11
      with:
        vcpkgGitCommitId: '1ee2e9d2920ba96be0b02c09915dd3c6d17fb50e'
        runVcpkgInstall: true

    - name: Configure CMake
      run: |
        cmake --preset windows-ninja-release

    - name: Build
      run: |
        cmake --build build-ninja --config Release

    - name: Check executable
      run: |
        Write-Host "=== File info ==="
        Get-ChildItem build-ninja\convert_fgd_dem_cpp.exe | Format-Table Name, Length
        Write-Host ""
        Write-Host "=== Dependencies (dumpbin) ==="
        dumpbin /dependents build-ninja\convert_fgd_dem_cpp.exe

    - name: Test executable
      run: |
        Write-Host "=== Testing executable ==="
        .\build-ninja\convert_fgd_dem_cpp.exe --help
        Write-Host "Executable runs successfully!"

    - name: Prepare artifacts
      run: |
        Write-Host "=== Preparing artifacts ==="

        New-Item -ItemType Directory -Force -Path artifacts

        # Copy executable
        Copy-Item build-ninja\convert_fgd_dem_cpp.exe artifacts\

        # Copy GDAL data files from vcpkg_installed
        $vcpkgInstalled = "vcpkg_installed\x64-windows-static"

        $gdalData = "$vcpkgInstalled\share\gdal"
        if (Test-Path $gdalData) {
          Copy-Item -Recurse $gdalData artifacts\gdal-data
          Write-Host "Copied GDAL data files"
        }

        # Copy PROJ data files from vcpkg_installed
        $projData = "$vcpkgInstalled\share\proj"
        if (Test-Path $projData) {
          Copy-Item -Recurse $projData artifacts\proj-data
          Write-Host "Copied PROJ data files"
        }

        # Copy documentation
        if (Test-Path README_WINDOWS.md) { Copy-Item README_WINDOWS.md artifacts\ }
        if (Test-Path README.md) { Copy-Item README.md artifacts\ }
        if (Test-Path LICENSE) { Copy-Item LICENSE artifacts\ }

        Write-Host ""
        Write-Host "=== Final artifacts summary ==="
        Write-Host "EXE files:"
        Get-ChildItem artifacts\*.exe | Format-Table Name, Length
        Write-Host "Total size: $([math]::Round((Get-ChildItem artifacts -Recurse | Measure-Object -Property Length -Sum).Sum / 1MB, 2)) MB"

    - name: Upload build logs
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: build-logs-x64-windows
        path: |
          build-ninja/**/*.log

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: convert-fgd-dem-cpp-windows-x64
        path: artifacts/
        retention-days: 30

    - name: Create Release Archive
      if: startsWith(github.ref, 'refs/tags/')
      run: |
        Compress-Archive -Path artifacts\* -DestinationPath convert-fgd-dem-cpp-windows-x64.zip

    - name: Upload Release Asset
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: convert-fgd-dem-cpp-windows-x64.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
